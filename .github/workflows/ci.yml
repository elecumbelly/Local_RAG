name: ci

on:
  push:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install uv
        run: python -m pip install uv
      - name: Install deps
        run: |
          if [ -f requirements.lock ]; then
            uv pip install --system -r requirements.lock
          else
            uv pip compile pyproject.toml -o requirements.lock
            uv pip install --system -r requirements.lock
          fi
      - name: Lint
        run: uv run ruff check .
      - name: Test
        run: uv run pytest
      - name: Type check (mypy)
        run: |
          python -m pip install mypy
          bash scripts/mypy-changed.sh
      - name: SBOM (syft)
        uses: anchore/syft-action@v0
        with:
          format: spdx-json
          output: backend-sbom.spdx.json
          source: .
          args: "--select-backend dir"
      - name: Container scan (trivy fs)
        uses: aquasecurity/trivy-action@0.16.1
        with:
          scan-type: "fs"
          scan-ref: "."
          ignore-unfixed: true
          format: "table"
      - name: Build API image
        run: |
          docker build -t local/api:ci -f Dockerfile .
      - name: Trivy image scan (api)
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: local/api:ci
          ignore-unfixed: true
          format: "table"
      - name: pip-audit
        run: |
          python -m pip install pip-audit
          pip-audit --progress-spinner=off
      - name: Bandit
        run: |
          python -m pip install bandit
          bandit -q -r src
      - name: Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: "p/default"
        env:
          SEMGREP_BASELINE_REF: ${{ github.event.pull_request.base.sha }}

  frontend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json
      - name: Install deps
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Build
        run: npm run build
      - name: Playwright install
        run: npx playwright install --with-deps
      - name: Playwright smoke
        run: npx playwright test
      - name: npm audit
        run: npm audit --production --audit-level=high
      - name: Build web image
        run: |
          docker build -t local/web:ci -f Dockerfile.prod .
      - name: Trivy image scan (web)
        uses: aquasecurity/trivy-action@0.16.1
        with:
          image-ref: local/web:ci
          ignore-unfixed: true
          format: "table"
